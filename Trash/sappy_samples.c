#include "sappy_engine.h"

// Simple sine wave sample for testing (256 samples, one period)
static const int8_t sineWaveData[] = {
    0, 3, 6, 9, 12, 16, 19, 22, 25, 28, 31, 34, 37, 40, 43, 46,
    49, 52, 54, 57, 60, 63, 65, 68, 71, 73, 76, 78, 81, 83, 86, 88,
    90, 92, 95, 97, 99, 101, 103, 105, 107, 108, 110, 112, 113, 115, 116, 118,
    119, 121, 122, 123, 124, 125, 126, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 126, 125, 124,
    123, 122, 121, 119, 118, 116, 115, 113, 112, 110, 108, 107, 105, 103, 101, 99,
    97, 95, 92, 90, 88, 86, 83, 81, 78, 76, 73, 71, 68, 65, 63, 60,
    57, 54, 52, 49, 46, 43, 40, 37, 34, 31, 28, 25, 22, 19, 16, 12,
    9, 6, 3, 0, -3, -6, -9, -12, -16, -19, -22, -25, -28, -31, -34, -37,
    -40, -43, -46, -49, -52, -54, -57, -60, -63, -65, -68, -71, -73, -76, -78, -81,
    -83, -86, -88, -90, -92, -95, -97, -99, -101, -103, -105, -107, -108, -110, -112, -113,
    -115, -116, -118, -119, -121, -122, -123, -124, -125, -126, -127, -127, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -127, -127,
    -126, -125, -124, -123, -122, -121, -119, -118, -116, -115, -113, -112, -110, -108, -107, -105,
    -103, -101, -99, -97, -95, -92, -90, -88, -86, -83, -81, -78, -76, -73, -71, -68,
    -65, -63, -60, -57, -54, -52, -49, -46, -43, -40, -37, -34, -31, -28, -25, -22,
    -19, -16, -12, -9, -6, -3
};

// Square wave sample
static const int8_t squareWaveData[] = {
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128
};

// Noise sample (pseudo-random)
static const int8_t noiseWaveData[] = {
    23, -45, 67, -89, 12, 34, -56, 78, -90, 11, 33, -55, 77, -99, 21, 43,
    -65, 87, -109, 31, 53, -75, 97, -119, 41, 63, -85, 107, -29, 51, 73, -95,
    117, -39, 61, 83, -105, 27, -49, 71, 93, -115, 37, -59, 81, 103, -25, 47,
    -69, 91, 113, -35, 57, -79, 101, 123, -45, 67, -89, 111, 33, -55, 77, -99,
    121, 43, -65, 87, -109, 31, 53, -75, 97, -119, 41, 63, -85, 107, -29, 51,
    73, -95, 117, -39, 61, 83, -105, 27, -49, 71, 93, -115, 37, -59, 81, 103,
    -25, 47, -69, 91, 113, -35, 57, -79, 101, 123, -45, 67, -89, 111, 33, -55,
    77, -99, 121, 43, -65, 87, -109, 31, 53, -75, 97, -119, 41, 63, -85, 107,
    -29, 51, 73, -95, 117, -39, 61, 83, -105, 27, -49, 71, 93, -115, 37, -59,
    81, 103, -25, 47, -69, 91, 113, -35, 57, -79, 101, 123, -45, 67, -89, 111,
    33, -55, 77, -99, 121, 43, -65, 87, -109, 31, 53, -75, 97, -119, 41, 63,
    -85, 107, -29, 51, 73, -95, 117, -39, 61, 83, -105, 27, -49, 71, 93, -115,
    37, -59, 81, 103, -25, 47, -69, 91, 113, -35, 57, -79, 101, 123, -45, 67,
    -89, 111, 33, -55, 77, -99, 121, 43, -65, 87, -109, 31, 53, -75, 97, -119,
    41, 63, -85, 107, -29, 51, 73, -95, 117, -39, 61, 83, -105, 27, -49, 71,
    93, -115, 37, -59, 81, 103, -25, 47, -69, 91, 113, -35, 57, -79, 101, 123
};

// Wave data structures with proper space allocation
// Using a struct with extra space for the sample data
typedef struct {
    SappyWaveData header;
    int8_t extraData[255];  // 256 total samples (1 in header + 255 extra)
} WaveDataWithSamples;

static WaveDataWithSamples gSineWaveData = {
    .header = {
        .type = 0,
        .status = 0,
        .freq = 0x10000,  // Base frequency (fixed point)
        .loopStart = 0,
        .size = 256,
        .data = {0}
    }
};

static WaveDataWithSamples gSquareWaveData = {
    .header = {
        .type = 0,
        .status = 0,
        .freq = 0x10000,
        .loopStart = 0,
        .size = 256,
        .data = {0}
    }
};

static WaveDataWithSamples gNoiseWaveData = {
    .header = {
        .type = 0,
        .status = 0,
        .freq = 0x10000,
        .loopStart = 0,
        .size = 256,
        .data = {0}
    }
};

// Pointers to the wave headers for external use
SappyWaveData *gSineWave = &gSineWaveData.header;
SappyWaveData *gSquareWave = &gSquareWaveData.header;
SappyWaveData *gNoiseWave = &gNoiseWaveData.header;

// Instrument definitions with different ADSR envelopes
SappyInstrument gPianoInstrument = {
    .type = 0,
    .key = 60,  // Middle C
    .length = 0,
    .pan_sweep = 64,  // Center pan
    .wave = NULL,  // Will be set in init
    .attack = 4,
    .decay = 8,
    .sustain = 200,
    .release = 32
};

SappyInstrument gOrganInstrument = {
    .type = 0,
    .key = 60,
    .length = 0,
    .pan_sweep = 64,
    .wave = NULL,  // Will be set in init
    .attack = 2,
    .decay = 4,
    .sustain = 240,
    .release = 16
};

SappyInstrument gDrumInstrument = {
    .type = 0,
    .key = 60,
    .length = 0,
    .pan_sweep = 64,
    .wave = NULL,  // Will be set in init
    .attack = 1,
    .decay = 4,
    .sustain = 0,
    .release = 64
};

// Initialize sample data
void sappy_init_samples(void) {
    // Copy sample data to wave structures
    // Note: In a real implementation, these would be in ROM
    for (int i = 0; i < 256; i++) {
        gSineWave->data[i] = sineWaveData[i];
        gSquareWave->data[i] = squareWaveData[i];
        gNoiseWave->data[i] = noiseWaveData[i];
    }
    
    // Set wave pointers in instruments
    gPianoInstrument.wave = gSineWave;
    gOrganInstrument.wave = gSquareWave;
    gDrumInstrument.wave = gNoiseWave;
}
